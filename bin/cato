#!/bin/sh #-x

function install_dependencies() {
	if [ -z "$1" ]
	then
		return
	fi

	PLATFORM="`xcrun --sdk macosx --show-sdk-platform-path`"
	SDK="`ls -d "$PLATFORM"/Developer/SDKs/*|head -n 1`"

	FRAMEWORKS=""
	for frameworks_dir in "$SDK"//System/Library/Frameworks $FRAMEWORKS_PATH
	do
		#  Â¯\_(ãƒ„)_/Â¯  http://unix.stackexchange.com/questions/65212/why-doesnt-this-xargs-command-work
		FRAMEWORKS="$FRAMEWORKS `ls -d $frameworks_dir/*.framework|xargs -L1 sh -c 'basename $1 .framework' dummy`"
	done

	cat <<EOF >$PKG_DIR/Podfile
platform :osx, '10.10'
plugin 'cocoapods-rome'
use_frameworks!
EOF

	grep '^import' $1|cut -d" " -f2|grep -v "`echo $FRAMEWORKS|sed 's/ /\\\|/g'`"| \
		sed 's/\(.*\)/pod "\1"/' >>$PKG_DIR/Podfile

	POD_CMD="pod install --project-directory=$PKG_DIR --no-repo-update --no-integrate"
	if [ -f Gemfile ]
	then
		bundle exec $POD_CMD
	else
		exec $POD_CMD
	fi
}

set -e

. /usr/local/opt/chswift/share/chswift/chswift.sh

SCRIPT="$2"
if [ ! -f "$1" ] && [ -n "$1" ]
then
	chswift "$1"
	shift
else
	chswift system
	SCRIPT="$1"
fi
shift

if [ ! -f "$SCRIPT" ]
then
	echo "Usage: $0 [SWIFT-VERSION] SCRIPT"
	exit 1
fi

SDK_PATH="`xcrun --show-sdk-path`"
FRAMEWORKS_PATH="$SDK_PATH/../../Library/Frameworks"

PKG_DIR="$HOME/.ðŸ“¦/`basename $SCRIPT .swift`"
mkdir -p "$PKG_DIR"

if [ ! -d "$PKG_DIR/Rome" ]
then
	install_dependencies "$SCRIPT"
fi

exec xcrun swift -F"$PKG_DIR/Rome" -F"$FRAMEWORKS_PATH" "$SCRIPT" $@
